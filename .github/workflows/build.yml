name: Build & Attach to Draft Release

on:
  release:
    types: [published]   # Runs when draft release is created
  workflow_dispatch:     # Allows manual trigger from Actions tab

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------
    # Parse version + prerelease flag
    # -------------------------------
    - name: Parse tag
      id: tag
      shell: pwsh
      run: |
        $tag = "${{ github.event.release.tag_name }}"
        $version = $tag.TrimStart("v")

        if ($version -match "-(alpha|beta)$") {
          echo "prerelease=true" >> $env:GITHUB_OUTPUT
        } else {
          echo "prerelease=false" >> $env:GITHUB_OUTPUT
        }

        echo "version=$version" >> $env:GITHUB_OUTPUT

    # -------------------------------
    # Prepare folders
    # -------------------------------
    - name: Create build directories
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force build/app | Out-Null
        New-Item -ItemType Directory -Force externalBins | Out-Null

    # -------------------------------
    # Download intunewinapputil.exe
    # -------------------------------
    - name: Download intunewinapputil.exe
      shell: pwsh
      run: |
        $url = "https://github.com/microsoft/Microsoft-Win32-Content-Prep-Tool/raw/master/IntuneWinAppUtil.exe"
        $out = "externalBins/intunewinapputil.exe"
        Invoke-WebRequest -Uri $url -OutFile $out

    # -------------------------------
    # Setup .NET
    # -------------------------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "8.0.x"

    # -------------------------------
    # Build application
    # -------------------------------
    - name: Publish application
      shell: pwsh
      run: |
        dotnet publish src/app/PackersTools `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -o build/app `
          -p:Version=${{ steps.tag.outputs.version }} `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true

    # -------------------------------
    # Write version.iss
    # -------------------------------
    - name: Generate version.iss
      shell: pwsh
      run: |
        $content = @"
        #define AppVersion "${{ steps.tag.outputs.version }}"
        "@
        Set-Content installer/version.iss $content -Encoding ASCII

    # -------------------------------
    # Install Inno Setup
    # -------------------------------
    - name: Install Inno Setup
      shell: pwsh
      run: choco install innosetup -y

    # -------------------------------
    # Build installer
    # -------------------------------
    - name: Build installer
      shell: pwsh
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\PackersTools.iss

    # -------------------------------
    # Generate SHA256 checksum
    # -------------------------------
    - name: Generate SHA256 checksum
      shell: pwsh
      run: |
        $installer = Get-ChildItem installer/Output -Filter *.exe | Select-Object -First 1

        if (-not $installer) {
          throw "Installer EXE not found"
        }

        $hash = Get-FileHash $installer.FullName -Algorithm SHA256
        "$($hash.Hash)  $($installer.Name)" |
          Set-Content "$($installer.FullName).sha256" -Encoding ASCII

    # -------------------------------
    # Upload files to existing draft release
    # -------------------------------
    - name: Upload assets to draft release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.release.tag_name }}
        files: |
          installer/Output/*.exe
          installer/Output/*.sha256